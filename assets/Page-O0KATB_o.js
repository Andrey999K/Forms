import{b as m,az as P,a6 as Y,f as V,h as H,k as $,bx as z,bz as B,bw as l,j as t,G as j,B as G,L as U,o as C,O as q,bV as W,bW as Q,bX as X}from"./index-CiIgmuQL.js";import{u as F}from"./usePageTitle-DCrDY3n3.js";import{S as E,u as J}from"./base-CyEkYK8f.js";import{S as K}from"./index-DfzRrm98.js";import{D as Z}from"./index-B9AQsqVm.js";import"./SearchOutlined-CJnaWDCl.js";var ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M505.7 661a8 8 0 0012.6 0l112-141.7c4.1-5.2.4-12.9-6.3-12.9h-74.1V168c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v338.3H400c-6.7 0-10.4 7.7-6.3 12.9l112 141.8zM878 626h-60c-4.4 0-8 3.6-8 8v154H214V634c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v198c0 17.7 14.3 32 32 32h684c17.7 0 32-14.3 32-32V634c0-4.4-3.6-8-8-8z"}}]},name:"download",theme:"outlined"},te=function(c,a){return m.createElement(P,Y({},c,{ref:a,icon:ee}))},se=m.forwardRef(te);const ae=()=>{const p=a=>{let d=a[0];return a.forEach(i=>{Object.keys(i)>Object.keys(d)&&(d=i)}),Object.keys(d)};return(a,d)=>{const r=[p(a),...a.map(x=>Object.values(x))].map(x=>x.join(",")).join(`
`),u=new Blob([r],{type:"text/csv"}),f=URL.createObjectURL(u),n=document.createElement("a");n.href=f,n.download=d||"download.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(f)}},{Text:ne,Title:v}=q,{RangePicker:oe}=Z,re="YYYY-MM-DD",ce=30,A={TIME_ASC:{field:"createdAt",type:E.ASC},TIME_DESC:{field:"createdAt",type:E.DESC}},le=[{value:"TIME_DESC",label:"Сначала новые"},{value:"TIME_ASC",label:"Сначала старые"}],fe=()=>{const p=V(),c=H(e=>e.responseSlice.status),[a,d]=$(),{formId:i}=z(),{data:r}=B(i??""),[u,f]=m.useState([]),[n,x]=m.useState(a.get("sort")??"TIME_DESC"),[o,N]=m.useState({start:a.get("start")?l.unix(Number(a.get("start"))):null,end:a.get("end")?l.unix(Number(a.get("end"))):null}),[k,b]=m.useState(!0),R=ae(),y=(()=>{const e=[];if(o.start&&(e==null||e.push({key:"createdAt",operator:">=",value:new Date(l(o.start).toDate())})),o.end){let s=o.end.clone();s=s.add(1,"day"),e==null||e.push({key:"createdAt",operator:"<=",value:new Date(s.toDate())})}return e})(),{ref:I}=J({threshold:1,onChange:async e=>{e&&c!=="pending"&&O()}});m.useEffect(()=>{const e={sort:n};o.start&&(e.start=o.start.unix().toString()),o.end&&(e.end=o.end.unix().toString()),d(e,{replace:!0})},[n,o,d]);const M=e=>{S(),x(e)},L=(e,s)=>{S(),N({start:s[0]?l(s[0]):null,end:s[0]?l(s[1]):null})},O=()=>{p(W({limit:ce,reference:{collectionName:"form",id:i??"",key:"formId"},filters:y,sort:A[n]})).unwrap().then(e=>{const s=e.data.data??[];if(!s.length){b(!1);return}f(h=>[...h,...s])})},S=()=>{p(Q()),b(!0),f([])},T=()=>{p(X({reference:{collectionName:"form",id:i??"",key:"formId"},filters:y,sort:A[n]})).unwrap().then(e=>{if(e.data.length){const s=e.data.map(h=>{const _=h.fields.reduce((w,g)=>(w[g.question]=Array.isArray(g.answer)?g.answer.join(", "):g.answer,w),{});return{id:h.id.toString(),..._,updateAt:l(h.updatedAt).toDate().toDateString(),createdAt:l(h.createdAt).toDate().toDateString()}});R(s,`${r==null?void 0:r.title}_responses`)}}).catch(()=>console.error("Cannot load csv"))},D=(c==="success"||c===null)&&k;return F(r?`Отклики | ${r.title}`:"Отклики"),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx(j,{className:"p-2",children:t.jsxs(v,{className:"!text-xl lg:px-0 md:!text-2xl",children:["Отклики формы ",t.jsx("br",{}),' "',r==null?void 0:r.title,'"']})}),t.jsxs(j,{className:"flex flex-col w-full gap-2 sm:justify-between sm:flex-row p-5",children:[t.jsx(K,{defaultValue:n,onChange:M,options:le,disabled:!u.length,className:"w-full sm:w-[200px] text-left"}),t.jsxs("div",{className:"flex gap-2 sm:justify-between",children:[t.jsx(oe,{defaultValue:[o.start,o.end],onChange:L,className:"w-full sm:max-w-[300px]",format:re,allowEmpty:!0,maxDate:l()}),t.jsx(G,{type:"primary",disabled:u.length===0,icon:t.jsx(se,{}),onClick:T})]})]}),t.jsxs(j,{className:"flex flex-col gap-4 p-5",children:[u.length?u.map((e,s)=>t.jsx(U,{to:`/forms/${i}/responses/${e.id}`,children:t.jsxs(j,{className:"hover:translate-y-[2px] transition duration-300 ease-in-out !shadow-none flex p-3 items-center justify-between gap-5",children:[t.jsxs(v,{italic:!0,level:5,style:{margin:0},children:["Отклик #",s+1]}),t.jsx(ne,{children:l(e.updatedAt).format("DD.MM.YYYY HH:mm:ss")})]})},e.id)):c!=="pending"&&!D&&t.jsx(v,{level:4,children:"У данной формы нет откликов."}),c==="pending"&&t.jsx(C,{}),D&&t.jsx("div",{ref:I,className:"mt-4 mb-5",children:t.jsx(C,{})}),c==="rejected"&&!u.length&&t.jsx(v,{level:4,children:"Произошла ошибка, попробуйте обновить страницу"})]})]})};export{fe as FormResponses};
