import{h as M,k as O,l as U,bv as Y,bx as $,b as x,bu as l,j as t,a9 as G,L as H,S as C,bD as V,bG as q,bH as B,bI as F}from"./index-B40_YZOi.js";import{S as w,u as Q,C as z}from"./base-BkrYkeNz.js";import{u as J}from"./usePageTitle-COwsTud2.js";import{S as K}from"./index-CLErNXFk.js";import{R as W}from"./DownloadOutlined-hQE_b536.js";import{D as X}from"./index-Br57LmMo.js";import"./Skeleton-B7yRBi31.js";import"./PlusOutlined-WB1ArnsU.js";import"./SearchOutlined-B_6lGwm5.js";const Z=()=>{const p=a=>{let c=a[0];return a.forEach(d=>{Object.keys(d)>Object.keys(c)&&(c=d)}),Object.keys(c)};return(a,c)=>{const o=[p(a),...a.map(f=>Object.values(f))].map(f=>f.join(",")).join(`
`),u=new Blob([o],{type:"text/csv"}),h=URL.createObjectURL(u),n=document.createElement("a");n.href=h,n.download=c||"download.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(h)}},{Text:ee,Title:g}=V,{RangePicker:te}=X,se="YYYY-MM-DD",ae=30,E={TIME_ASC:{field:"createdAt",type:w.ASC},TIME_DESC:{field:"createdAt",type:w.DESC}},ne=[{value:"TIME_DESC",label:"Сначала новые"},{value:"TIME_ASC",label:"Сначала старые"}],he=()=>{const p=M(),i=O(e=>e.responseSlice.status),[a,c]=U(),{formId:d}=Y(),{data:o}=$(d??""),[u,h]=x.useState([]),[n,f]=x.useState(a.get("sort")??"TIME_DESC"),[r,k]=x.useState({start:a.get("start")?l.unix(Number(a.get("start"))):null,end:a.get("end")?l.unix(Number(a.get("end"))):null}),[A,j]=x.useState(!0),N=Z(),v=(()=>{const e=[];if(r.start&&(e==null||e.push({key:"createdAt",operator:">=",value:new Date(l(r.start).toDate())})),r.end){let s=r.end.clone();s=s.add(1,"day"),e==null||e.push({key:"createdAt",operator:"<=",value:new Date(s.toDate())})}return e})(),{ref:R}=Q({threshold:1,onChange:async e=>{e&&i!=="pending"&&L()}});x.useEffect(()=>{const e={sort:n};r.start&&(e.start=r.start.unix().toString()),r.end&&(e.end=r.end.unix().toString()),c(e,{replace:!0})},[n,r,c]);const I=e=>{S(),f(e)},T=(e,s)=>{S(),k({start:s[0]?l(s[0]):null,end:s[0]?l(s[1]):null})},L=()=>{p(q({limit:ae,reference:{collectionName:"form",id:d??"",key:"formId"},filters:v,sort:E[n]})).unwrap().then(e=>{const s=e.data.data??[];if(!s.length){j(!1);return}h(m=>[...m,...s])})},S=()=>{p(B()),j(!0),h([])},P=()=>{p(F({reference:{collectionName:"form",id:d??"",key:"formId"},filters:v,sort:E[n]})).unwrap().then(e=>{if(e.data.length){const s=e.data.map(m=>{const _=m.fields.reduce((D,b)=>(D[b.question]=Array.isArray(b.answer)?b.answer.join(", "):b.answer,D),{});return{id:m.id.toString(),..._,updateAt:l(m.updatedAt).toDate().toDateString(),createdAt:l(m.createdAt).toDate().toDateString()}});N(s,`${o==null?void 0:o.title}_responses`)}}).catch(()=>console.error("Cannot load csv"))},y=(i==="success"||i===null)&&A;return J(o?`Отклики | ${o.title}`:"Отклики"),t.jsxs(t.Fragment,{children:[t.jsxs(g,{className:"mt-10 px-5 !text-2xl lg:px-0 md:!text-4xl",children:["Отклики формы ",t.jsx("br",{}),' "',o==null?void 0:o.title,'"']}),t.jsxs("div",{className:"flex flex-col w-full gap-2 mt-10 mb-4 sm:justify-between sm:flex-row",children:[t.jsx(K,{defaultValue:n,onChange:I,options:ne,disabled:!u.length,className:"w-full sm:w-[200px] text-left"}),t.jsxs("div",{className:"flex gap-2 sm:justify-between",children:[t.jsx(te,{defaultValue:[r.start,r.end],onChange:T,className:"w-full sm:max-w-[300px]",format:se,allowEmpty:!0,maxDate:l()}),t.jsx(G,{type:"primary",disabled:u.length===0,icon:t.jsx(W,{}),onClick:P})]})]}),t.jsx("div",{className:"flex flex-col gap-4 mb-4",children:u.length?u.map((e,s)=>t.jsx(H,{to:`/forms/${d}/responses/${e.id}`,children:t.jsx(z,{className:"bg-[#fdf8f4]/85 backdrop-blur-sm hover:backdrop-blur-sm hover:bg-[#fdf8f4] hover:-translate-y-1 hover:shadow-lg transition duration-200 ease-in-out",children:t.jsxs("div",{className:"flex items-center justify-between gap-5",children:[t.jsxs(g,{italic:!0,level:5,style:{margin:0},children:["Отклик #",s+1]}),t.jsx(ee,{children:l(e.updatedAt).toString()})]})})},e.id)):i!=="pending"&&!y&&t.jsx(g,{level:2,children:"У данной формы нет откликов."})}),i==="pending"&&t.jsx("div",{className:"mb-5 mt-4",children:t.jsx(C,{})}),y&&t.jsx("div",{ref:R,className:"mt-4 mb-5",children:t.jsx(C,{})}),i==="rejected"&&!u.length&&t.jsx(g,{level:2,children:"Произошла ошибка, попробуйте обновить страницу"})]})};export{he as FormResponses};
