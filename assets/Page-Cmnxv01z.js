import{f as _,h as O,k as Y,bC as B,bE as H,b as x,bB as l,j as t,B as U,L as $,S as C,bK as V,bN as q,bO as G,bP as F}from"./index-D0_mvqW_.js";import{S as w,u as K,C as Q}from"./base-DjUFSbLR.js";import{u as z}from"./usePageTitle-BftMZdFN.js";import{S as J}from"./index-4ymjqknC.js";import{R as W}from"./DownloadOutlined-Cq8r9vDX.js";import{D as X}from"./index-uE4gTEnH.js";import"./Skeleton-D0TrJe31.js";import"./SearchOutlined-B2XEae2l.js";import"./PlusOutlined-CyErr4vi.js";const Z=()=>{const p=a=>{let c=a[0];return a.forEach(d=>{Object.keys(d)>Object.keys(c)&&(c=d)}),Object.keys(c)};return(a,c)=>{const o=[p(a),...a.map(h=>Object.values(h))].map(h=>h.join(",")).join(`
`),u=new Blob([o],{type:"text/csv"}),f=URL.createObjectURL(u),r=document.createElement("a");r.href=f,r.download=c||"download.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(f)}},{Text:ee,Title:g}=V,{RangePicker:te}=X,se="YYYY-MM-DD",ae=30,E={TIME_ASC:{field:"createdAt",type:w.ASC},TIME_DESC:{field:"createdAt",type:w.DESC}},re=[{value:"TIME_DESC",label:"Сначала новые"},{value:"TIME_ASC",label:"Сначала старые"}],fe=()=>{const p=_(),i=O(e=>e.responseSlice.status),[a,c]=Y(),{formId:d}=B(),{data:o}=H(d??""),[u,f]=x.useState([]),[r,h]=x.useState(a.get("sort")??"TIME_DESC"),[n,k]=x.useState({start:a.get("start")?l.unix(Number(a.get("start"))):null,end:a.get("end")?l.unix(Number(a.get("end"))):null}),[A,j]=x.useState(!0),N=Z(),v=(()=>{const e=[];if(n.start&&(e==null||e.push({key:"createdAt",operator:">=",value:new Date(l(n.start).toDate())})),n.end){let s=n.end.clone();s=s.add(1,"day"),e==null||e.push({key:"createdAt",operator:"<=",value:new Date(s.toDate())})}return e})(),{ref:R}=K({threshold:1,onChange:async e=>{e&&i!=="pending"&&L()}});x.useEffect(()=>{const e={sort:r};n.start&&(e.start=n.start.unix().toString()),n.end&&(e.end=n.end.unix().toString()),c(e,{replace:!0})},[r,n,c]);const I=e=>{y(),h(e)},T=(e,s)=>{y(),k({start:s[0]?l(s[0]):null,end:s[0]?l(s[1]):null})},L=()=>{p(q({limit:ae,reference:{collectionName:"form",id:d??"",key:"formId"},filters:v,sort:E[r]})).unwrap().then(e=>{const s=e.data.data??[];if(!s.length){j(!1);return}f(m=>[...m,...s])})},y=()=>{p(G()),j(!0),f([])},M=()=>{p(F({reference:{collectionName:"form",id:d??"",key:"formId"},filters:v,sort:E[r]})).unwrap().then(e=>{if(e.data.length){const s=e.data.map(m=>{const P=m.fields.reduce((D,b)=>(D[b.question]=Array.isArray(b.answer)?b.answer.join(", "):b.answer,D),{});return{id:m.id.toString(),...P,updateAt:l(m.updatedAt).toDate().toDateString(),createdAt:l(m.createdAt).toDate().toDateString()}});N(s,`${o==null?void 0:o.title}_responses`)}}).catch(()=>console.error("Cannot load csv"))},S=(i==="success"||i===null)&&A;return z(o?`Отклики | ${o.title}`:"Отклики"),t.jsxs(t.Fragment,{children:[t.jsxs(g,{className:"mt-10 px-5 !text-2xl lg:px-0 md:!text-4xl",children:["Отклики формы ",t.jsx("br",{}),' "',o==null?void 0:o.title,'"']}),t.jsxs("div",{className:"flex flex-col w-full gap-2 mt-10 mb-4 sm:justify-between sm:flex-row",children:[t.jsx(J,{defaultValue:r,onChange:I,options:re,disabled:!u.length,className:"w-full sm:w-[200px] text-left"}),t.jsxs("div",{className:"flex gap-2 sm:justify-between",children:[t.jsx(te,{defaultValue:[n.start,n.end],onChange:T,className:"w-full sm:max-w-[300px]",format:se,allowEmpty:!0,maxDate:l()}),t.jsx(U,{type:"primary",disabled:u.length===0,icon:t.jsx(W,{}),onClick:M})]})]}),t.jsx("div",{className:"flex flex-col gap-4 mb-4",children:u.length?u.map((e,s)=>t.jsx($,{to:`/forms/${d}/responses/${e.id}`,children:t.jsx(Q,{className:"bg-[#fdf8f4]/85 backdrop-blur-sm hover:backdrop-blur-sm hover:bg-[#fdf8f4] hover:-translate-y-1 hover:shadow-lg transition duration-200 ease-in-out",children:t.jsxs("div",{className:"flex items-center justify-between gap-5",children:[t.jsxs(g,{italic:!0,level:5,style:{margin:0},children:["Отклик #",s+1]}),t.jsx(ee,{children:l(e.updatedAt).format("DD.MM.YYYY HH:mm:ss")})]})})},e.id)):i!=="pending"&&!S&&t.jsx(g,{level:2,children:"У данной формы нет откликов."})}),i==="pending"&&t.jsx("div",{className:"mb-5 mt-4",children:t.jsx(C,{})}),S&&t.jsx("div",{ref:R,className:"mt-4 mb-5",children:t.jsx(C,{})}),i==="rejected"&&!u.length&&t.jsx(g,{level:2,children:"Произошла ошибка, попробуйте обновить страницу"})]})};export{fe as FormResponses};
