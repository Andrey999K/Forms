import{f as Y,h as O,k as H,bF as $,bH as B,b as x,bE as l,j as t,G as j,B as G,L as U,o as w,bB as V,b$ as q,c0 as F,c1 as Q}from"./index-4A4D1OQ8.js";import{u as W}from"./usePageTitle-3txOEyNo.js";import{S as E,u as z}from"./base-DYKq8EIZ.js";import{S as J}from"./index-CdsFuZHg.js";import{R as K}from"./DownloadOutlined-B-U5D-H5.js";import{D as X}from"./index-BZSkCv66.js";import"./SearchOutlined-BRx-Ztwi.js";const Z=()=>{const p=a=>{let c=a[0];return a.forEach(d=>{Object.keys(d)>Object.keys(c)&&(c=d)}),Object.keys(c)};return(a,c)=>{const o=[p(a),...a.map(h=>Object.values(h))].map(h=>h.join(",")).join(`
`),u=new Blob([o],{type:"text/csv"}),f=URL.createObjectURL(u),n=document.createElement("a");n.href=f,n.download=c||"download.csv",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(f)}},{Text:ee,Title:y}=V,{RangePicker:te}=X,se="YYYY-MM-DD",ae=30,A={TIME_ASC:{field:"createdAt",type:E.ASC},TIME_DESC:{field:"createdAt",type:E.DESC}},ne=[{value:"TIME_DESC",label:"Сначала новые"},{value:"TIME_ASC",label:"Сначала старые"}],me=()=>{const p=Y(),i=O(e=>e.responseSlice.status),[a,c]=H(),{formId:d}=$(),{data:o}=B(d??""),[u,f]=x.useState([]),[n,h]=x.useState(a.get("sort")??"TIME_DESC"),[r,N]=x.useState({start:a.get("start")?l.unix(Number(a.get("start"))):null,end:a.get("end")?l.unix(Number(a.get("end"))):null}),[k,b]=x.useState(!0),R=Z(),S=(()=>{const e=[];if(r.start&&(e==null||e.push({key:"createdAt",operator:">=",value:new Date(l(r.start).toDate())})),r.end){let s=r.end.clone();s=s.add(1,"day"),e==null||e.push({key:"createdAt",operator:"<=",value:new Date(s.toDate())})}return e})(),{ref:I}=z({threshold:1,onChange:async e=>{e&&i!=="pending"&&M()}});x.useEffect(()=>{const e={sort:n};r.start&&(e.start=r.start.unix().toString()),r.end&&(e.end=r.end.unix().toString()),c(e,{replace:!0})},[n,r,c]);const L=e=>{v(),h(e)},T=(e,s)=>{v(),N({start:s[0]?l(s[0]):null,end:s[0]?l(s[1]):null})},M=()=>{p(q({limit:ae,reference:{collectionName:"form",id:d??"",key:"formId"},filters:S,sort:A[n]})).unwrap().then(e=>{const s=e.data.data??[];if(!s.length){b(!1);return}f(m=>[...m,...s])})},v=()=>{p(F()),b(!0),f([])},P=()=>{p(Q({reference:{collectionName:"form",id:d??"",key:"formId"},filters:S,sort:A[n]})).unwrap().then(e=>{if(e.data.length){const s=e.data.map(m=>{const _=m.fields.reduce((C,g)=>(C[g.question]=Array.isArray(g.answer)?g.answer.join(", "):g.answer,C),{});return{id:m.id.toString(),..._,updateAt:l(m.updatedAt).toDate().toDateString(),createdAt:l(m.createdAt).toDate().toDateString()}});R(s,`${o==null?void 0:o.title}_responses`)}}).catch(()=>console.error("Cannot load csv"))},D=(i==="success"||i===null)&&k;return W(o?`Отклики | ${o.title}`:"Отклики"),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx(j,{className:"p-2",children:t.jsxs(y,{className:"!text-xl lg:px-0 md:!text-2xl",children:["Отклики формы ",t.jsx("br",{}),' "',o==null?void 0:o.title,'"']})}),t.jsxs(j,{className:"flex flex-col w-full gap-2 sm:justify-between sm:flex-row p-5",children:[t.jsx(J,{defaultValue:n,onChange:L,options:ne,disabled:!u.length,className:"w-full sm:w-[200px] text-left"}),t.jsxs("div",{className:"flex gap-2 sm:justify-between",children:[t.jsx(te,{defaultValue:[r.start,r.end],onChange:T,className:"w-full sm:max-w-[300px]",format:se,allowEmpty:!0,maxDate:l()}),t.jsx(G,{type:"primary",disabled:u.length===0,icon:t.jsx(K,{}),onClick:P})]})]}),t.jsxs(j,{className:"flex flex-col gap-4 p-5",children:[u.length?u.map((e,s)=>t.jsx(U,{to:`/forms/${d}/responses/${e.id}`,children:t.jsxs(j,{className:"hover:translate-y-[2px] transition duration-300 ease-in-out !shadow-none flex p-3 items-center justify-between gap-5",children:[t.jsxs(y,{italic:!0,level:5,style:{margin:0},children:["Отклик #",s+1]}),t.jsx(ee,{children:l(e.updatedAt).format("DD.MM.YYYY HH:mm:ss")})]})},e.id)):i!=="pending"&&!D&&t.jsx(y,{level:4,children:"У данной формы нет откликов."}),i==="pending"&&t.jsx(w,{}),D&&t.jsx("div",{ref:I,className:"mt-4 mb-5",children:t.jsx(w,{})}),i==="rejected"&&!u.length&&t.jsx(y,{level:4,children:"Произошла ошибка, попробуйте обновить страницу"})]})]})};export{me as FormResponses};
